---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import SponsorBanner from '@/components/SponsorBanner.astro';
import MemberPaywall from '@/components/MemberPaywall.astro';

// Support banner placement (can later become sponsor ads)
const SHOW_SUPPORT_BANNER = true;
const BANNER_PLACEMENT = 'after-header'; // 'after-header' | 'before-footer' | 'both'

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await post.render();
const isMemberOnly = post.data.memberOnly;
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={post.data.ogImage || `/og/${post.slug}.png`}
  type="article"
>
  <article class="max-w-4xl mx-auto px-6 pt-4 pb-12">
    <header class="mb-8">
      <img
        src={post.data.ogImage || `/og/${post.slug}.png`}
        alt={post.data.title}
        class="w-full rounded-lg mb-6"
        width="1200"
        height="630"
      />
      <h1 class="sr-only">{post.data.title}</h1>
      <div class="flex flex-wrap items-center gap-4 text-zinc-500 dark:text-zinc-400 mb-2">
        <time>
          {post.data.pubDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })}
        </time>
        {post.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {post.data.tags.map((tag) => (
              <span class="text-xs px-2 py-1 bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 rounded">
                {tag}
              </span>
            ))}
          </div>
        )}
      </div>
      <a href="/blog" class="text-brand-orange underline decoration-brand-orange/30 hover:decoration-brand-orange text-sm">
        &larr; Back to blog
      </a>
    </header>

    {SHOW_SUPPORT_BANNER && !isMemberOnly && (BANNER_PLACEMENT === 'after-header' || BANNER_PLACEMENT === 'both') && (
      <SponsorBanner placement="after-header" />
    )}

    {isMemberOnly ? (
      <>
        {/* Paywall - shown by default */}
        <div id="member-paywall">
          <MemberPaywall title={post.data.title} description={post.data.description} returnUrl={`/blog/${post.slug}`} />
        </div>

        {/* Member content - hidden by default, revealed via JS if authenticated */}
        <div id="member-content" class="hidden">
          <div class="prose prose-zinc dark:prose-invert prose-headings:text-zinc-900 dark:prose-headings:text-zinc-100 prose-a:text-brand-orange prose-code:text-brand-orange max-w-none">
            <iframe
              src={`https://api.tamm.in/content/${post.slug}`}
              title={post.data.title}
              class="w-full rounded-lg border border-zinc-200 dark:border-zinc-700"
              style="height: 600px; background: #1a1a1a;"
              loading="lazy"
            ></iframe>
          </div>
        </div>

        <script>
          // Check auth and swap paywall for content if authenticated
          (async () => {
            try {
              const res = await fetch('https://api.tamm.in/auth/status', { credentials: 'include' });
              const data = await res.json();
              if (data.authenticated && data.isMember) {
                document.getElementById('member-paywall')?.classList.add('hidden');
                document.getElementById('member-content')?.classList.remove('hidden');
              }
            } catch (e) {
              // Auth check failed, keep paywall visible
            }
          })();
        </script>
      </>
    ) : (
      <div class="prose prose-zinc dark:prose-invert prose-headings:text-zinc-900 dark:prose-headings:text-zinc-100 prose-a:text-brand-orange prose-code:text-brand-orange max-w-none">
        <Content />
      </div>
    )}

    {SHOW_SUPPORT_BANNER && !isMemberOnly && (BANNER_PLACEMENT === 'before-footer' || BANNER_PLACEMENT === 'both') && (
      <SponsorBanner placement="before-footer" />
    )}

    <!-- Author byline -->
    <footer class="mt-12 pt-8 border-t border-zinc-200 dark:border-zinc-700">
      <a href="/about" class="flex items-center gap-4 group no-underline">
        <img
          src="/tamm-portrait.jpg"
          alt="Tamm Sjödin"
          width="64"
          height="64"
          class="w-16 h-16 rounded-full object-cover flex-shrink-0"
        />
        <div>
          <p class="font-semibold text-zinc-900 dark:text-zinc-100 group-hover:text-brand-orange transition-colors">
            Tamm Sjödin
          </p>
          <p class="text-sm text-zinc-500 dark:text-zinc-400">
            Web Sorceress & Engineering Leader · Founder of Queer Run Club · Swede in Sydney
          </p>
        </div>
      </a>
    </footer>
  </article>
</BaseLayout>
